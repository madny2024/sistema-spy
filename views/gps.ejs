<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>MÓDULO GPS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Estilo do Painel de Conexão */
        .connect-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #ff003c;
            padding: 20px;
            z-index: 9999;
            width: 300px;
            color: white;
            font-family: monospace;
        }
        .input-hacker {
            background: #000;
            border: 1px solid #00ff41;
            color: #00ff41;
            padding: 10px;
            width: 100%;
            font-size: 1.2rem;
            text-align: center;
            margin-bottom: 10px;
            font-family: monospace;
            text-transform: uppercase;
        }
        .btn-hacker {
            background: #ff003c;
            color: black;
            border: none;
            width: 100%;
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-hacker:hover { background: white; }
    </style>
</head>
<body>
    <a href="/" class="btn-back">< VOLTAR</a>

    <div class="connect-overlay" id="login-panel">
        <h3 style="color: #ff003c; text-align: center;">CONEXÃO SEGURA</h3>
        <p style="font-size: 0.8rem; text-align: center; margin-bottom: 15px;">DIGITE O CÓDIGO DO ALVO:</p>
        
        <input type="text" id="target-id" class="input-hacker" placeholder="EX: 8F2A" maxlength="4">
        <button onclick="startTracking()" class="btn-hacker">RASTREAR AGORA</button>
        <p id="msg" style="text-align: center; margin-top: 10px; font-size: 0.8rem;"></p>
    </div>

    <div class="module-container">
        <div class="sidebar">
            <div class="box">
                <h2 class="red-glow">DADOS DO ALVO</h2>
                <br>
                <p>ID CONECTADO: <span id="dev-id" style="color:#00ff41">AGUARDANDO...</span></p>
                <p>BATERIA: <span id="bat-level">--%</span></p>
                <p>STATUS: <span class="red-glow blink" id="status-txt">DESCONECTADO</span></p>
            </div>
        </div>

        <div class="main-display">
            <div id="map"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const socket = io();
        const map = L.map('map').setView([-15.793889, -47.882778], 4); // Começa no Brasil
        let targetId = null;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Sistema de Rastreamento'
        }).addTo(map);

        const redIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#ff003c; width: 15px; height: 15px; border-radius: 50%; box-shadow: 0 0 10px #ff003c;'></div>",
            iconSize: [15, 15],
            iconAnchor: [7, 7]
        });
        const marker = L.marker([0, 0], {icon: redIcon}).addTo(map);

        // Função chamada ao clicar no botão RASTREAR
        function startTracking() {
            const input = document.getElementById('target-id').value.toUpperCase();
            if(input.length < 1) return;
            
            targetId = input;
            document.getElementById('msg').innerText = "BUSCANDO SINAL DO ALVO: " + targetId + "...";
            document.getElementById('msg').style.color = "yellow";
        }

        socket.on('gps_update', (data) => {
            // AQUI É A MÁGICA: Só atualiza se o ID for igual ao digitado
            // Ou se o campo estiver vazio, mostramos qualquer um (modo debug)
            if (targetId && data.id !== targetId) return;

            document.getElementById('login-panel').style.display = 'none'; // Esconde o login ao achar
            
            document.getElementById('dev-id').innerText = data.id || "DESCONHECIDO";
            document.getElementById('bat-level').innerText = data.battery + '%';
            document.getElementById('status-txt').innerText = "RASTREADO EM TEMPO REAL";
            document.getElementById('status-txt').style.color = "#00ff41";
            
            const newLatLng = [data.lat, data.lng];
            marker.setLatLng(newLatLng);
            map.setView(newLatLng, 16); // Zoom automático
        });
    </script>
</body>
</html>